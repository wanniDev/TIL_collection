# OS Basic 요약 -1- thread와 process

**자바 스레드를 이해하는데, 운영체제에서 다루는 스레드를 알아야하는 이유?**

자바의 스레드는 JVM 내부의 'Thread Library'에서 생성하는 native thread에 의해 관리 받습니다. 그 native thread는 운영체제의 스케쥴러에 의해 관리 받습니다. 즉, 자바의 스레드는 사용자 수준의 스레드에 불가하기 때문에, 실질적인 IO 작업은 커널 수준의 스레드에게 작업을 요청합니다.

따라서, 자바의 스레드에서 수행하는 대부분의 작업은 운영체제의 스레드로부터 비롯되기 때문에, 자바의 스레드 모델을 이해하려면 운영체제의 스레드를 이해하는 과정이 선행되어야 합니다.

## Process & Thread

**Process**

- 운영체제에 의해 설치되어 있는 프로그램
- 운영체제로부터 자원을 할당받은 최소 작업 단위

**Thread**

- 프로세스가 운영체제의 자원을 이용하는 하나 이상의 실행단위(Task)
- code, data, heap 영역은 각 스레드들이 공유
- 함수의 경우 스레드 별로 고유의 stack을 할당받고 독립적으로 호출

**Thread & CPU**

- CPU의 최소 실행 단위
- 스케줄러에 의해 한 개의 스레드가 선점되어 cpu에 할당됨
- 스레드 선점이 일어날 때마다 컨텍스트 스위칭이 발생

**Process & Thread**

| Process                                                      | Thread                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 자식 프로세스 하나에 문제가  발생해도 다른 프로세스들에게 영향을 미치지 않는다. | 하나의 스레드만 문제가 생겨도 전체 프로세스에 영향을 미친다. |
| 컨텍스트 스위칭 비용이 크다.                                 | 컨텍스트 스위칭 비용이 저렴하다.                             |
| 프로세스 생성 비용이 크다.                                   | 스레드 생성 비용이 저렴하다.                                 |
| 프로세스 간 통신 기법이 어렵고 복잡하며 오버헤드 역시 크다.  | 스레드 간 통신 비용이 저렴하다.                              |

### 동시성 과 병렬성

**동시성**

- 하나의 CPU 코어가 한 번에 많은 일을 처리함.
- 각 스레드의 task를 최소 단위로 분리하여, 병행할 수도 있고, 순차적으로 처리할 수도 있음.

**병렬성**

- 여러 CPU 코어가 동시에 많은 일을 처리함.
- 동시성은 작업 처리 방식에 대한 설계였다면, 병렬성은 하드웨어 계층에서 작업을 처리하는 방식에 관한 개념.

자바에서는 이러한 동시성과 병렬성을 조합하여, **ThreadPoolExecutor, ForkJoinPool**로 활용합니다.

### Context Switch

하나의 CPU는 여러 Task를 동시에 실행할 수 없기 때문에 여러 프로세스를 동시성으로 처리하기 위해, 한 프로세스에서 다른 프로세스로 전환하는 'Context Switch'를 수행합니다.

**Context**

- Context는 CPU가 프로세스를 실행하기 위한 프로세으의 정보를 의미합니다.
- 이 정보들은 운영체제가 관리하는 PCB 라고 하는 자료구조의 공간에 저장됩니다.

**PCB (Process Control Block)**

- 운영체제가 시스템 내의 프로세스를 관리하기 위해 프로세스마다 유지하는 정보를 담는 커널 내의 자료구조
- 컨텍스트 스위칭은 CPU가 프로세스 간 PCB 정보를 교체하고 캐시를 비우는 일련의 과정

**Context Switching이 일어나는 조건**

- 실행 중인 프로세스에서 I/O 호출이 일어나 해당 작업이 끝날때까지 프로세스 상태가 running에서 waiting 상태로 전이된 경우
- Round robin 스케쥴링에 따라 현재 실행중인 프로세스가 할당된 시간 자원을 모두 사용했을 때 해당 프로세스를 중지하고 다른 프로세스를 실행시켜주는 경우

### Thread에서의 Context Switch

- 프로세스 정보를 담는 자료구조로 PCB가 있다면, 스레드의 정보를 담는 TCB(Thread Control Block)이 있습니다.
- 스레드가 생성될 때마다 PCB 내에서 TCB가 생성되며, 컨텍스트 스위칭이 발생하면 기존 스레드의 TCB를 저장하고 새로운 스레드의 TCB를 실행합니다.

**스레드의 Context Switch 특징**

- 프로세스는 컨텍스트 스위칭할 때 CPU 캐시 초기화, TLB 초기화, MMU 주소 체계 수정 등 여러가지 메모리 주소 관련 일을 수행하여 오버헤드가 큽니다.
- 하지만 스레드는 프로세스 내 메모리를 공유하기 때문에 추가 작업 없이 프로세스에 비해 오버헤드가 작아서 컨텍스트 스위칭이 빠릅니다.
- 하지만, 스레드는 생성 비용이 높아서 너무 많이 생성할 경우 메모리 부족 현상 혹은 빈번한 컨텍스트 스위칭으로 성능이 저하될 수 있습니다.