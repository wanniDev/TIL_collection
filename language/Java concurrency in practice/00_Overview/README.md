# 개요

## 멀티 프로세스 소프트웨어가 필요하게된 배경

- **자원 활용** : 프로그램의 입출력 동작이 끝나기를 기다리는 동안, 다른 프로그램을 실행하도록 지원하는 행위가 필요해졌다.
- **공정성** : 여러 사용자와 프로그램이 컴퓨터 내 자원에 대해 동일한 권한을 가질 수 있다. 한 번에 프로그램 하나를 끝까지 실행해 종료된 이후에야 다른 프로그램을 시작하는 것보다는 더 작은 단위로 컴퓨터를 공유하는 방법이 바람직하다.
- **편의성** : 때론 여러 작업을 전부 처리하는 프로그램 하나를 작성하는 것보다 각기 일을 하나씩 처리하고 필요할 때 프로그램 간에 조율하는 프로그램을 여러 개 작성하는 편이 더 쉽고 바람직하다.

## 스레드의 이점

- 개발 및 유지 보수 비용을 줄이고 복잡한 애플리케이션의 성능을 향상시킬 수 있다.
- 어렵지만 제대로 활용하면, 비동기적인 일 흐름을 거의 순차적으로 바꿀 수 있어 사람이 일하고 상호 작용하는 방식의 모델링이 쉬워진다.
- 꼬인 코드를 새로 작성해 읽기 쉽고 유지보수하기도 쉬운 명료한 코드로 만들 수도 있다.

## 단순한 모델링의 필요성

- 소프트웨어는 한 종류의 일을 순차적으로 처리하는 프로그램은 작성하기 쉽고 오류도 별로 생기지 않는다.
- 즉, 비동기적인 작업 흐름을 각기 별도 스레드에서 수행되는 더 단순하고 동기적인 작업 흐름 몇 개로 나눌 수 있다.
- 대표적으로 서블릿과 같은 웹 프레임워크에서 종종 활용된다.
  - 요청 관리
  - 스레드 생성
  - 로드 밸런싱
  - 작업 흐름 내 적절한 컴포넌트 요청 분배 등 상세한 부분을 처리해준다.

## 단순한 비동기 이벤트 처리

- 서버 애플리케이션에서 각 연결마다 스레드를 할당하고 Blocking I/O를 사용하면 개발 작업이 쉬워진다.
- 단일 스레드의 경우, 다른 요청이 병목현상에 끼지 않도록 넌블록킹 I/O를 활용해야하지만, 작업이 복잡하고 실수할 확률도 커진다.
- 프로세스가 생성할 수 있는 스레드 개수가 수백 개 정도밖에 안되었을 때는 유닉스 시스템의 select나 poll 과 같이 효율적인 다중화 IO 수단을 개발했다.
  - 표준 JAVA의 경우 `java.nio`와 같은 패키지를 추가했다.
- 그러나 운영체제에서 생성할 수 있는 스레드가 높아짐에 따라, 일부 플랫폼에서는 클라이언트당 하나의 스레드를 생성하는 일이 많아졌다.

## 스레드 사용의 위험성

- 자바 자체에서 제공하는 스레드 관련 기능은 정형화된 메모리 모델(write-once, run-anywhere)로 병렬 프로그래밍이 쉬워졌지만, 그만큼 개발자에 대한 기대치도 높아졌다.
- 따라서, 개발자라면, 대부분 스레드 안정성(thread safety)에 대해 잘 알아야 한다.
- 그런데, 스레드 안정성에 너무 치우치면 성능에 대한 레버리지가 낮아지고, 성능에 치우치면 스레드 안정성이 떨어진다.

## 활동성 위험

- 데드락, 기아상태, 라이브락 등 여러 가지 활동성 장애 유형이 있다.
- 이 문제들은 작업의 상대적인 타이밍에 따라 활동성 문제점이 나타나기 때문에 개발이나 테스트 도중에 잘 드러나지는 않는다.

## 스레드는 어디에나

> 프레임워크는 프로그램 컴포넌트를 호출할 때 프레임워크 내부의 스레드에서 호출하기 때문에 자동으로 프로그램이 스레드를 활용하는 것과 동일한 효과를 준다. 컴포넌트는 언제나 프로그램 내부의 상태에 접근하기 때문에 해당 상태에 접근하는 모든 코드 경로에 해당하는 컴포넌트 역시 스레드에 안전해야 한다.

**서블릿과 JSP** : 

- 서블릿은 웹 애플리케이션을 배치하고 원격 HTTP 클라이언트에서 오는 요청을 분배하기 위한 모든 기본 기능을 감당하도록 설계되어 있다.
- 그러나, 서블릿도 역시 여러 스레드에서 동시에 요청을 호출할 수 있기 때문에 역시 스레드에 안전해야 한다.
- 서블릿은 application-scope 객체(ServletContext) 혹은 session-scoped 객체(클라이언트별 HttpSession 객체) 처럼 다른 서블릿과 공유하는 상태 정보에 접근할 때도 있기 때문에, 스레드 안전성에 신경 써야 한다.